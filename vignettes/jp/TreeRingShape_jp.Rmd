---
title: "TreeRingShape"
author: "Megumi ISHIDA"
date: "`r Sys.Date()`"
# output: 
#   html_document:
#     toc: true
#     toc_float: true
#     　collapsed: false
#     　 number_sections: true
output: rmarkdown::html_vignette

vignette: >
  %\VignetteIndexEntry{TreeRingShape}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```



このパッケージは幹の円板の全年輪の形状を効率的に記録するためのものです。
GISソフト(Qgis)で入力した**放射計測線**上の**年輪ポイント( P )**と**代表年輪ライン( L )**から、**代表年輪間の年輪( L2 )を補完**します。
**「代表年輪」**とは、外周および円板の形を特徴づける年輪で形が真円に近いほど少なくてすみます。
年輪は髄を中心として同心円状に成長しますが、その形状は真円ではありません。
これまでの年輪解析や年輪年代学では、年輪幅から樹木の成長を評価したものが
多いですが、近年では画像解析の技術の発達に伴い年輪面積によって成長評価しよ
うとする研究も増えてきています。これらの研究は、殆ど年輪が明瞭な針葉樹
人工林の円板試料が調査対象でしたが、本パッケージでは年輪形状がより複雑
な天然林の樹木の年輪形状の記録も可能となります。
ただし、現状年輪形状に関する情報を手入力する必要があるため、
多くの労力を要することをお断りしておきます。

![Qgis](Qgis2R.jpg)


#### 実   行

TreeRingShape()によってクラスS4の　classTreeRingShape　を設定し、
年輪補完を実行、年輪形状データを完成させます。

#### Table 1. classTreeRingShape : TR <- TreeRingShape()
| Slot  |  R | Qgis |                                                         
|:----------|:--------------------------------------|:---------------------------- | 
| ***Input*** | 
|**P**| **data frame of Tree Ring Points**|Points shape, field(id,ring)  |
|P_filename |shape file name of tree ring points | *.shp |
|P_id.tag   |column name of id in shape file (P)| default  'id'|
|P_ring.tag	|column name of ring no.(ordinaly year,outermost=0)|default  'ring'|
|**L**| **list of Representative Tree Ring Lines**|Lines shape, field(ring)|
|L_filename |shape file name for representative tree ring lines (L) |*.shp |   
|L_ring.tag |column name of ring no.(ordinaly year,outermost=0) in shape file (L)| default  'ring'|
|***Append***| 
|**L2**| **list of All Tree Ring Lines including interpolated lines**|Lines shape, field(ring) |
|L2_filename|file name of shape file (L2) for tree ring lines interpolated  |*.shp | 
| **etc.** |see **classTreeRingShape** for details|


##### Usage

** sample data of 'Abies_277_h400' can be download from **
 https://www.sanchikanri.com/treering/Abies_277_h400.zip
 
library(TreeRingShape)

TR.<-TreeRingShape(
P_filename='Abies_277_h400_TreeRing_Points.shp',
L_filename='Abies_277_h400_TreeRing_Representative.shp',
L2_filename='Abies_277_h400_TreeRing.shp',
P_id.tag='id',P_ring.tag='ring',
L_ring.tag='ring')

<br><br>
実行後、 *Append* (Table 1) のデータが追加されます。


## 手　順
### I.　円板の処理
1. 幹の円板を採取します。
　枝、腐り、割れのある部分は極力避けます。

1. 年輪がよく見えるようになるまで研磨します。

1. 鉛筆で髄から原則8方向に線を描きます。以下、この線を **放射計測線** と呼びます。  

1. 形成層(樹皮と接する材の外周)を0とし内側に向かって年輪を数え、マーキングしていきます。

1. 全放射計測線上の年輪数が一致していることを確認します。

1. 鉛筆で代表的な年輪のラインをトレースしておきます。
    年輪数が多い、年輪数が不明瞭な部分がある場合など、作業効率が良くなります。

### II. 円板全体の画像のスキャング
* 円板全体の年輪の画像を1200dpi以上でスキャンします。
  フラットヘッドのスキャナー、もしくは幾何補正できる高解像度デジタルカメラが利用できます。  

### III. Qgisを用いた年輪座標の入力

### 1. プロジェクトのプロパティ
1. プロジェクトの **CRS ** は「使用しない」に設定します。
1. デフォルトのCRSは空欄とします。

### 2. レイヤの追加
1. 年輪画像ラスターを取り込みます(TreeRing***.tif)。
1. 年輪ポイントの新規シェープファイルレイヤーの作成(TreeRingPoints***.shp)
    属性テーブルに整数integerで **id** と **ring** の項目を設けます。

1. 年輪ラインの新規シェープファイルレイヤーの作成(TreeRingLines***.shp)
   属性テーブルに整数integerで **ring** の項目を設けます。
   
### 3.手作業による年輪座標の入力
1. 年輪ポイント
    **id**は放射計測線の番号、もしくは修正ポイントグループの番号、
    **ring**は通常、形成層を0とし内側に向かって数えた年輪数です。
    放射計測線上のすべての年輪にポイントを打ちます。
    年輪補完を実施した後、年輪がずれている場合、年輪が必ず通過する補正点を追加入力します。

1. 代表年輪ライン
外周および円板の形を特徴づける年輪のラインをなぞりながら年輪の座標を入力します。
形成層を0とし内側に向かって数えた年輪数です。

### IV .TreeRingShapeによる解析

 ```{r setup}
library(TreeRingShape)
names(TR)  # TR is a sample object of classTreeRingShape S4
help("classTreeRingShape-class",package="TreeRingShape")
 Lplot(TR@L)
 points(TR@P,pch=".",col="blue")
TR. <- TreeRingsInterpolation(TR)
ya <- plot_year_RingArea(TR.@L2, 2018)$Year_TreeRingArea
plot(ya,type='b')
tri. <- TreeRingIndex(ya)
lines(tri.$spline,col='red',lw=2)
plot(tri.$idx,type='b')
abline(h=1,col='red')
```

<!-- ```{r setup} -->
<!-- library(TreeRingShape) -->
<!-- names(TR)  # TR is a sample object of classTreeRingShape S4 -->
<!-- help("classTreeRingShape-class",package="TreeRingShape") -->
<!--  Lplot(TR@L) -->
<!--  points(TR@P,pch=".",col="blue") -->
<!-- TR. <- TreeRingsInterpolation(TR) -->
<!-- ya <- plot_year_RingArea(TR.@L2, 2018)$Year_TreeRingArea -->
<!-- plot(ya,type='b') -->
<!-- tri. <- TreeRingIndex(ya) -->
<!-- lines(tri.$spline,col='red',lw=2) -->
<!-- plot(tri.$idx,type='b') -->
<!-- abline(h=1,col='red') -->
<!-- ``` -->


### 引 用

Pebesma, E., & Bivand, R. (2023). Spatial Data Science: With Applications in R. Chapman and Hall/CRC.
  https://doi.org/10.1201/9780429459016    
  
QGIS Development Team. (2024). QGIS Geographic Information System. QGIS Association. https://www.qgis.org







